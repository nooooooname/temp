## 操作系统概述
一提到操作系统，你可能会感到既熟悉又陌生，Windows就是一个操作系统，大家天天都在用，因此感到很熟悉。然而要问到操作系统的具体概念，头脑中却只有一个模糊不清印象，所以会感到陌生。笔者能体会这种陌生的感觉，笔者查阅过一些操作系统的权威书籍，几乎没见到过像 “操作系统是 *定语* + *名词* ”这样干脆利落的定义，以至于在下文的某处不得不加上一句“按照笔者的理解”。本章首先介绍了操作系统的概念，然后简单讲解了操作系统是如何引导的，最后简要介绍了蜂鸟操作系统的各个组成部分。

另外，下文中出现的16进制数使用汇编语言的语法表示，即数字后边加一个字母h，若最高位是a~f则在前边加一个0。

### 什么是操作系统
按照笔者的理解，操作系统是：
* 为应用程序提供环境
* 管理硬件驱动程序
* 以文件的形式管理磁盘数据
* 具有输入输出功能

的一种软件。它是一种软件，和一般的应用软件相比没有本质上的区别，只不过比应用软件特殊一些。我们平时用的应用软件都有很明确的用途，比如word，你可以用来写论文，比如QQ，你可以用来聊天斗图，比如各种游戏，你可以用来愉悦身心获得快乐。但操作系统好像没有什么明显的用途，Windows操作系统我们天天都在用，可是我们用它来干嘛呢？想象一下，假如你的电脑没装操作系统，刚才提到的word、QQ还有游戏你能安装吗？显然不能，所以为应用程序提供环境就是操作系统的用途之一，我们在使用那些应用软件的同时，也是在使用操作系统。

驱动程序是一种控制硬件设备，使它能正常工作的程序。驱动程序的英文是Driver，这更有助于理解：硬件设备就好比一辆车，要让它跑起来就必须有一位司机，这位“司机”就是驱动程序。和其他程序一样，驱动程序要运行就必然需要分配内存，当它不再使用时就需要回收内存。由于驱动程序要对硬件进行各种操作，因此需要获得较高的权限，另外大多数驱动程序都会用到中断。分配与回收内存、授予权限以及维护中断向量表等涉及到驱动程序管理的工作都要由操作系统来完成。

一般电脑中的数据都是保存在硬盘里的，硬盘读写的单位是扇区（1扇区=512字节），CPU读写硬盘只能一扇区一扇区的读写。然而用户对数据的操作却是以文件形式进行的，比如你在网上发现了一部想看的电影，这部电影以某种格式编码成一堆二进制数据，你要把它下载下来，那一定是告诉下载器一个路径让它把这堆数据保存成一个文件，而不是告诉下载器这堆数据的前512字节放在哪个扇区，第二个512字节放在哪个扇区……这种以文件形式操作数据的功能正是操作系统提供的，操作系统有一个非常重要的子系统，叫“文件系统”，它在硬盘的各个分区上建立庞大而复杂的数据结构，从而在茫茫多的扇区之上抽象出一个个文件和目录，最后把数据以文件的形式呈现给用户。

操作系统，顾名思义，用来操作电脑的系统。既然让用户操作，就必须有输入输出系统。应用程序在开发过程中使用的各种输入输出函数并不是本身自带输入输出功能，而是通过调用操作系统的输入输出功能来获取用户的输入或者往屏幕上输出。所以归根结底，输入输出过程中关键的操作还是由操作系统完成的。

### 操作系统的引导过程
在计算机的主板上有一块CMOS（互补金属氧化物半导体）芯片，这块芯片里储存着一段叫做基本输入输出系统（BIOS）的程序，在用户按下开机键后，CPU就开始执行BIOS程序。BIOS程序主要负责检测内存大小，扫描连在主板上的各个硬件设备并检查它们是否有故障。然后按照用户指定的顺序依次检查各个存储设备上的第一个扇区的后2个字节，若这2个字节是55h和0aah（MBR标志）则将该设备的第一个扇区读到内存的7c00h处，然后跳转到7c00h开始执行该扇区中一段被称为主引导记录（MBR）的代码。主引导记录遍历所在存储设备上的所有分区，找到被标记为“活动”的分区后便启动存储在这个分区里的操作系统。

### 蜂鸟操作系统的组成部分
* 内核

内核包含了系统的初始化代码、系统调用以及许多重要的变量。其中初始化代码负责完成从系统被引导到第一个进程运行前的所有工作，在整个操作系统中最先运行但只运行一次。系统调用是一种特殊的中断程序，它主要用于内存和页表的管理以及进程的创建和销毁。系统调用随内核被装入后便常驻内存。

* 硬盘驱动模块

硬盘驱动主要负责提供底层的读写硬盘功能，该功能最重要的用途是确保文件系统能正常工作，所以硬盘驱动模块在系统初始化时就要被加载。

* 文件系统模块

该模块提供所有和文件系统以及分区相关的功能，包括创建文件，删除文件，读文件，写文件，创建分区，格式化分区和删除分区。文件系统模块由系统初始化代码加载。

* 终端模块

该模块向应用程序提供除文件操作外的基本功能，同样由系统初始化代码加载。

* 外壳

外壳是系统中第一个进程，它在蜂鸟操作系统中的作用就如同bash在Linux系统中的作用一样，是操作系统和用户交互的“前台”，负责接收用户输入的命令并响应。外壳进程由系统初始化代码创建，随后在系统中一直存在直到关机。

## 搭建开发环境
本章讲述了如何搭建蜂鸟操作系统的开发环境，如何编译项目，以及如何用bochs运行与调试。这套开发环境可以搭建在Linux或Windows平台上，至于其他平台，因为笔者没有用过，所以不甚了解。如果你熟悉开发环境中的这些软件并且有安装经验，可以有选择的跳过某些小节。需要说明的是，这些软件只是笔者认为的最佳选择，并不是唯一选择。

### NASM汇编器
蜂鸟操作系统使用x86汇编语言编写，所以就需要一个汇编器。NASM全称The Netwide Assembler，是一个为可移植性与模块化而设计的80x86的汇编器。它支持相当多的目标文件格式，包括Linux和BSD下的a.out，ELF，COFF，Mach-O，16位和32位的OBJ(OMF)格式，以及Win32和Win64。它还可以输出纯二进制文件。它的语法设计得相当简洁易懂，和Intel语法相似但更简单。它支持“Pentium”、“P6”、“MMX”、“3DNow!”、“SSE”和“SSE2”指令集。

NASM的安装过程比较简单，访问[NASM的官方网站](https://www.nasm.us)并点击页面上方的DOWNLOAD，然后选择一个版本，笔者安装的版本是2.13.03。在接下来的页面中带有doc字样的是NASM的文档，nasm-2.13.03.XXX是软件源码，而那几个文件夹里的是各操作系统下的NASM安装程序或免安装压缩包。在Linux下编译安装的方法如下：

```
$ wget https://www.nasm.us/pub/nasm/releasebuilds/2.13.03/nasm-2.13.03.tar.xz	#下载
$ tar -xJvf nasm-2.13.03.tar.xz							#解压缩
$ cd nasm-2.13.03/								#进入源码目录
$ ./configure									#配置
$ make										#编译
$ sudo make install								#安装
```

唯一有可能出问题的是配置那一步，在配置那一步中如果报了错，那一定是系统中没有安装某个NASM所依赖的软件导致的，根据报错信息安装缺少的软件后重新配置即可。如果修改了可执行文件的安装路径并且新路径不在环境变量PATH中，则需要修改PATH将它添加进去。安装好之后执行nasm –v，若能输出NASM的版本信息则安装无误。

NASM的安装方法不止这一种，但其他安装方法都是傻瓜式的，只要注意修改环境变量PATH即可，故在此不做详细叙述。

### bochs模拟器
bochs是一个高度可移植的开源x86 PC模拟器，采用C++编写，可以运行在大多数流行的平台上。它包括了对英特尔x86 CPU、通用I/O设备和自定义BIOS的模拟。bochs可以用来模拟多种不同的x86 CPU，涵盖了从早期的386到近期英特尔和AMD的x86_64处理器。它就像一个虚拟机，不过对我们来说最重要的还要数它的调试功能，你可以让这台虚拟机每执行一条机器指令就暂停一次，然后查看各寄存器、内存的值。对于我们开发出的操作系统来说是一个绝佳的调试环境。

## 内核

## 进程与可执行文件

## 模块机制

## 文件系统

## 终端模块

## 外壳
